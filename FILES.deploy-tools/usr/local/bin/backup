#!/bin/bash
. /etc/nds-backup-config
[ $DEBUG ] && set -x

MYADDR=$(ip addr show eth0 | grep "inet\b" | awk '{print $2}' | cut -d/ -f1)
DATE=$(date +%y-%m-%d-%H.%M)
eval PROBES=(${PEERS})
PEER0=${PROBES[1]}

# First of the bunch does etcd and kubectl parts
if [[ ${PEER0} != ${MYADDR} ]]; then
    # etcd
    rm -rf /tmp/etcd && etcdctl backup --data-dir=/var/lib/etcd --backup-dir=/tmp/etcd
    (cd /tmp && tar czf - etcd | ssh -i ${BACKUP_KEY} ${BACKUP_USER}@${BACKUP_HOST} "sudo cat - >  ${BACKUP_PATH}/${DATE}-etcd.tgz" )

    # kubectl dump
    kubectl cluster-info dump | ssh -i ${BACKUP_KEY} ${BACKUP_USER}@${BACKUP_HOST} "sudo cat - >  ${BACKUP_PATH}/${DATE}-kubectl.dump"
fi

# All brick servers do a brick dump
xfsdump - ${BRICK_PATH} | ssh -i ${BACKUP_KEY} ${BACKUP_USER}@${BACKUP_HOST} "sudo cat - > ${BACKUP_PATH}/${DATE}-${MYADDR}.brick.dump"

